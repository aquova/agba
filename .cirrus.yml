linux_task:
  container:
    image: rust:latest

  setup_script:
    - apt-get update
    - apt-get -y install libsdl2-dev zip

  build_script:
    - make sdl

  package_script:
    - mkdir -p agba/assets
    - cp sdl/assets/icon_purple.png agba/assets
    - cp sdl/target/debug/agba_sdl agba/agba
    - zip -r agba_linux.zip agba

  agba_artifacts:
    path: agba_linux.zip

osx_task:
  osx_instance:
    image: catalina-base

  setup_script:
    - brew update
    - brew install rust sdl2

  build_script:
    - make sdl

  package_script:
    - mkdir -p agba/assets
    - cp sdl/assets/icon_purple.png agba/assets
    - cp sdl/target/debug/agba_sdl agba/agba
    - zip -r agba_mac.zip agba

  agba_artifacts:
    path: agba_mac.zip

win_task:
  container:
    image: rust:1.44.0

  setup_script:
    - apt-get update
    - apt-get -y install libsdl2-dev zip gcc-mingw-w64-x86-64
    # This is from sdl/setup_win.sh
    - rustup target add x86_64-pc-windows-gnu
    - cp -r sdl/lib/SDL2-2.0.12/x86_64-w64-mingw32/lib/* $RUSTUP_HOME/toolchains/1.44.0-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-pc-windows-gnu/lib
    - cp sdl/lib/SDL2-2.0.12/x86_64-w64-mingw32/bin/SDL2.dll sdl

  build_script:
    - make windows

  package_script:
    - mkdir -p agba/assets
    - cp sdl/assets/icon_purple.png agba/assets
    - cp sdl/*.dll agba
    - cp sdl/agba_sdl.exe agba/agba.exe
    - zip -r agba_win.zip agba

  agba_artifacts:
    path: agba_win.zip

wasm_task:
  container:
    image: rust:latest

  setup_script:
    - apt-get update
    - apt-get -y install zip
    # Install wasm-pack
    - curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

  build_script:
    - make wasm

  package_script:
    - zip -r agba_wasm.zip web

  agba_artifacts:
    path: agba_wasm.zip
